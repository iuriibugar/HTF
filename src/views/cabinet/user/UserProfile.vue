<template>
  <div class="w-full h-full flex flex-col overflow-y-auto">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-yellow-400 mb-2">üìã –ú–æ—ó –¥–∞–Ω—ñ</h1>
      <p class="text-gray-300">–û–Ω–æ–≤—ñ—Ç—å –≤–∞—à—É –æ—Å–æ–±–∏—Å—Ç—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é</p>
    </div>

    <!-- –§–æ—Ä–º–∞ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1">
      <!-- –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
      <div class="lg:col-span-2 bg-gray-800/60 backdrop-blur-md rounded-2xl p-6 border-2 border-gray-700">
        <h2 class="text-lg font-semibold text-yellow-400 mb-4">–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–Ü–º'—è</label>
            <input 
              v-model="formData.firstName" 
              type="text" 
              placeholder="–í–∞—à–µ —ñ–º'—è"
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-400 focus:outline-none transition"
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–ü—Ä—ñ–∑–≤–∏—â–µ</label>
            <input 
              v-model="formData.lastName" 
              type="text" 
              placeholder="–í–∞—à–µ –ø—Ä—ñ–∑–≤–∏—â–µ"
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-400 focus:outline-none transition"
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label>
            <input 
              v-model="formData.birthDate" 
              type="date"
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white focus:border-yellow-400 focus:outline-none transition"
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–°—Ç–∞—Ç—å</label>
            <select 
              v-model="formData.gender" 
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white focus:border-yellow-400 focus:outline-none transition">
              <option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Å—Ç–∞—Ç—å</option>
              <option value="male">–ß–æ–ª–æ–≤—ñ–∫</option>
              <option value="female">–ñ—ñ–Ω–∫–∞</option>
              <option value="other">–Ü–Ω—à–µ</option>
            </select>
          </div>
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
      <div class="lg:col-span-2 bg-gray-800/60 backdrop-blur-md rounded-2xl p-6 border-2 border-gray-700">
        <h2 class="text-lg font-semibold text-yellow-400 mb-4">üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input 
              v-model="formData.phone" 
              type="tel" 
              placeholder="+38 (099) 123-45-67"
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-400 focus:outline-none transition"
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–ú—ñ—Å—Ç–æ</label>
            <input 
              v-model="formData.city" 
              type="text" 
              placeholder="–í–∞—à–µ –º—ñ—Å—Ç–æ"
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-400 focus:outline-none transition"
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–ê–¥—Ä–µ—Å–∞</label>
            <input 
              v-model="formData.address" 
              type="text" 
              placeholder="–í—É–ª–∏—Ü—è, –¥—ñ–º"
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-400 focus:outline-none transition"
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</label>
            <input 
              v-model="formData.postalDepartment" 
              type="text" 
              placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∏—ó–≤ ‚Ññ1"
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-400 focus:outline-none transition"
            >
          </div>
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞ –≤ —Ä–∞–∑—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ -->
      <div class="lg:col-span-2 bg-gray-800/60 backdrop-blur-md rounded-2xl p-6 border-2 border-gray-700">
        <h2 class="text-lg font-semibold text-yellow-400 mb-4">üÜò –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞ –≤ —Ä–∞–∑—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–Ü–º'—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ—ó –æ—Å–æ–±–∏</label>
            <input 
              v-model="formData.emergencyContactName" 
              type="text" 
              placeholder="–Ü–º'—è —ñ –ø—Ä—ñ–∑–≤–∏—â–µ"
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-400 focus:outline-none transition"
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ—ó –æ—Å–æ–±–∏</label>
            <input 
              v-model="formData.emergencyContactPhone" 
              type="tel" 
              placeholder="+38 (099) 123-45-67"
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-400 focus:outline-none transition"
            >
          </div>
        </div>
      </div>

      <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å–ø–æ—Ä—Ç -->
      <div class="lg:col-span-2 bg-gray-800/60 backdrop-blur-md rounded-2xl p-6 border-2 border-gray-700">
        <h2 class="text-lg font-semibold text-yellow-400 mb-4">üèä –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å–ø–æ—Ä—Ç</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–†—ñ–≤–µ–Ω—å –¥–æ—Å–≤—ñ–¥—É</label>
            <select 
              v-model="formData.experienceLevel" 
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white focus:border-yellow-400 focus:outline-none transition">
              <option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Ä—ñ–≤–µ–Ω—å</option>
              <option value="beginner">–ü–æ—á–∞—Ç–∫—ñ–≤–µ—Ü—å</option>
              <option value="intermediate">–°–µ—Ä–µ–¥–Ω—ñ–π —Ä—ñ–≤–µ–Ω—å</option>
              <option value="advanced">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∏–π</option>
              <option value="professional">–ü—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è</label>
            <select 
              v-model="formData.specialization" 
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white focus:border-yellow-400 focus:outline-none transition">
              <option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é</option>
              <option value="swimming">–ü–ª–∞–≤–∞–Ω–Ω—è</option>
              <option value="cycling">–í–µ–ª–æ—Å–ø–æ—Ä—Ç</option>
              <option value="running">–ë—ñ–≥</option>
              <option value="triathlon">–¢—Ä–∏–∞—Ç–ª–æ–Ω</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">–ü—Ä–æ —Å–µ–±–µ</label>
            <textarea 
              v-model="formData.bio" 
              rows="4"
              placeholder="–†–æ–∑–ø–æ–≤—ñ–¥—å—Ç–µ –ø—Ä–æ —Å–µ–±–µ..."
              class="w-full px-4 py-2 bg-gray-700/50 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-yellow-400 focus:outline-none transition resize-none"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –¥—ñ—ó -->
      <div class="lg:col-span-2 flex gap-3 mt-auto pt-6">
        <button 
          @click="saveProfile"
          :disabled="isSaving"
          class="flex-1 bg-yellow-500 hover:bg-yellow-600 disabled:bg-gray-500 text-black font-bold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2">
          <span v-if="!isSaving">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏</span>
          <span v-else>‚è≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...</span>
        </button>
        <button 
          @click="resetForm"
          class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition">
          ‚Ü∫ –í—ñ–¥–º—ñ–Ω–∏—Ç–∏
        </button>
      </div>

      <!-- –°—Ç–∞—Ç—É—Å –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è -->
      <div v-if="saveStatus" class="lg:col-span-2 p-4 rounded-lg" :class="saveStatus.type === 'success' ? 'bg-green-900/30 border-2 border-green-500 text-green-300' : 'bg-red-900/30 border-2 border-red-500 text-red-300'">
        {{ saveStatus.message }}
      </div>
    </div>

    <!-- –ù–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è -->
    <Notification
      :show="notification.show"
      :type="notification.type"
      :message="notification.message"
      @close="notification.show = false"
    />
  </div>
</template>

<script setup>
import { ref, onMounted, watch } from 'vue'
import { auth } from '@/firebase'
import { onAuthStateChanged } from 'firebase/auth'
import { useRoute } from 'vue-router'
import { getUserProfile, updateUserProfile } from '@/services/userService'
import Notification from '@/components/Notification.vue'
import { showLoader, hideLoader } from '@/stores/loaderStore'

const route = useRoute()

const formData = ref({
  firstName: '',
  lastName: '',
  birthDate: '',
  gender: '',
  phone: '',
  city: '',
  address: '',
  postalDepartment: '',
  emergencyContactName: '',
  emergencyContactPhone: '',
  experienceLevel: '',
  specialization: '',
  bio: ''
})

const originalData = ref({})
const isSaving = ref(false)
const saveStatus = ref(null)
const notification = ref({
  show: false,
  type: 'success',
  message: ''
})

function showNotification(type, message) {
  notification.value = {
    show: true,
    type,
    message
  }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
const loadUserData = async () => {
  try {
    showLoader()
    const user = auth.currentUser
    if (!user) {
      hideLoader()
      return
    }

    const profile = await getUserProfile(user.uid)
    
    if (profile) {
      formData.value = {
        firstName: profile.firstName || '',
        lastName: profile.lastName || '',
        birthDate: profile.birthDate || '',
        gender: profile.gender || '',
        phone: profile.phone || '',
        city: profile.city || '',
        address: profile.address || '',
        postalDepartment: profile.postalDepartment || '',
        emergencyContactName: profile.emergencyContactName || '',
        emergencyContactPhone: profile.emergencyContactPhone || '',
        experienceLevel: profile.experienceLevel || '',
        specialization: profile.specialization || '',
        bio: profile.bio || ''
      }
      // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–∏–±–æ–∫—É –∫–æ–ø—ñ—é –¥–ª—è originalData
      originalData.value = JSON.parse(JSON.stringify(formData.value))
    }
  } catch (error) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö:', error)
    saveStatus.value = {
      type: 'error',
      message: '‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö'
    }
  }
  finally {
    hideLoader()
  }
}

// –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–∞–Ω—ñ
const saveProfile = async () => {
  try {
    isSaving.value = true
    showLoader()

    const user = auth.currentUser
    if (!user) {
      throw new Error('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π')
    }

    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ç—ñ–ª—å–∫–∏ –∑–º—ñ–Ω–µ–Ω—ñ –ø–æ–ª—è, –ø–æ—Ä—ñ–≤–Ω—é—é—á–∏ –∑ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–º–∏
    const dataToSave = {}
    let changedFields = 0
    
    Object.keys(formData.value).forEach(key => {
      const currentValue = formData.value[key]
      const originalValue = originalData.value[key]
      
      // –Ø–∫—â–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–º—ñ–Ω–∏–ª–æ—Å—å
      if (currentValue !== originalValue) {
        // –Ø–∫—â–æ –ø–æ–ª–µ –ø—É—Å—Ç–µ, –ø–µ—Ä–µ–¥–∞—î–º–æ null (—â–æ–± –æ—á–∏—Å—Ç–∏—Ç–∏ –≤ –ë–î)
        // –Ü–Ω–∞–∫—à–µ –ø–µ—Ä–µ–¥–∞—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è —è–∫ —î
        dataToSave[key] = currentValue === '' ? null : currentValue
        changedFields++
      }
    })
    
    if (changedFields === 0) {
      showNotification('info', '‚ÑπÔ∏è –ù–µ –±—É–ª–æ –∑–º—ñ–Ω –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è')
      return
    }
    
    await updateUserProfile(user.uid, dataToSave)
    
    // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ —â–æ–± –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—å —â–æ –≤—Å–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ
    await loadUserData()
    
    showNotification('success', '‚úÖ –î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ!')
    saveStatus.value = {
      type: 'success',
      message: '‚úÖ –î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ'
    }

    setTimeout(() => {
      saveStatus.value = null
    }, 3000)

  } catch (error) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', error)
    showNotification('error', '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –¥–∞–Ω–∏—Ö: ' + error.message)
    saveStatus.value = {
      type: 'error',
      message: '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –¥–∞–Ω–∏—Ö'
    }
  } finally {
    isSaving.value = false
    hideLoader()
  }
}

// –°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏
const resetForm = () => {
  formData.value = { ...originalData.value }
  saveStatus.value = null
}

// –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
onMounted(() => {
  // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –≤—ñ–¥—Ä–∞–∑—É
  if (auth.currentUser) {
    loadUserData()
  } else {
    // –Ü–Ω–∞–∫—à–µ —á–µ–∫–∞—î–º–æ –Ω–∞ —Å—Ç–∞–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loadUserData()
      }
    })
  }
})

// –°–ª—ñ–¥–∏—Ç–∏ –∑–∞ –º–∞—Ä—à—Ä—É—Ç–æ–º —ñ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –Ω–∞ —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É
watch(() => route.path, (newPath) => {
  if (newPath === '/user/profile') {
    loadUserData()
  }
})

// –ü—Ä–∏ —Ä–æ–∑–º–æ–Ω—Ç—É–≤–∞–Ω–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
import { onBeforeUnmount } from 'vue'
onBeforeUnmount(() => {
  // –û—á–∏—â—É—î–º–æ —Ñ–æ—Ä–º—É
  Object.keys(formData.value).forEach(key => {
    formData.value[key] = ''
  })
})
</script>
